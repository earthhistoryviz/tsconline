# Server

---

## Setup

---

### assets

---

We set up the assets folder to contain all supporting files. The jars are not found on the public repo since they contain sensitive information on private applications.

```lua
server
`-- assets
    |-- datapacks
    |   |-- *.dpk
    |   |-- *.mdpk
    |   |-- *.map
    |   `-- *.txt
    |-- decrypted
    |   `--[decrypted datapacks]
    |-- uploads
    |   `--[uuid]
    |       `--datapacks
    |-- jars
    |   | -- TSCreator.jar
    |   ` -- decrypt.jar
    |-- adminconfig.json
    `-- configs.json
```

We keep datapacks used on the server in this folder `assets/datapacks`. The configs.json folder will detail which of this datapacks are to be used in the `activeDatapacks` field.

Again, make sure to denote the name of your jars in their respective fields. EX. (`decryptionJar: "assets/jars/decrypt.jar"`)

`configs.json` contains all the information of where assets are to be used on the server side. This is asserted in `server/src/types.ts`. Any changes to `configs.json` will need to be additionally changed in the `types.ts` files.

`uploads` directory contains all the user uploaded datapacks

`assetconfig.json` contains all the added configurations any admin user uploads

---

### public

---

We hold all the service files here for the app. The app is able to access all files so do not put any sensitive information here (including the decrypted datapacks and jars). The presets, mapimages, and charts cache are all located here.

#### public/presets

The presets in `public/presets` will contain specific configurations of certain datapack combinations. The naming convention of these will be `public/presets/*-*` (EX: 001-TSC2020). The `config.json` will hold the information for each preset. **Right now, the settings parser, xml to json, and json to xml functions are not working so the settings are currently default.**

**_Ask Professor Ogg for any preset ideas._**

#### public/charts

This holds the charts in a hashed directory. The hash consists of an `md5` hash of the chart settings and chart datapacks. This ensures that if they request the same chart, we can just use the cached version. Both the chart and settings file used in the java jar are kept here for cache use.

#### public/mapimages

This holds any map images if the datapacks used are those with [map points](#Parse-MapPacks). There is currently no cleanup here.

---

## Initializing the server

---

### yarn start

On starting the server with `yarn start`, the server will create a fastify server listening on port `3000`

We then `glob` all the presets by parsing each preset in `public/presets`. This is done in `src/preset.ts`. Any error here will simply dismiss that folder/preset and the server will continue running.

After grabbing all the pre-initialized presets we parse the `assets/config.json` file to grab all the correct filepaths and datapacks to be used. Any error in reading this config file will stop the server.

### Session

The session key represents the user's session. This is an encrypted string generated by the `fastify-secure-session` plugin when the user logs in. The encryption key is hardcoded in local environments (to facilitate easy login) but is set through an environment variable in development and production environments. This session key, stored in the `loginSession` cookie, contains the UUID of the user so we can easily attach the user to the session.

This allows the user to stay logged in even if they refresh the page. This also allows us to verify that the user is logged in and to get the user's potentially confidential information.

Session keys will last for 1 week. After 1 week, their cookie used for login will expire and they will have to log in again.

### Datapacks

Datapacks can be unencrypted or encrypted but must be in a certain format for us to be able to display settings correctly. This is what we use `decrypt.jar` for. We give the datapacks parsed from `assets/config.json` and the destination also located in that file for the decrypted packs and decrypt said datapacks. Any errors like a datapack formatted or encrypted wrong will result in the datapack not being decrypted.

The end result will have folders within the decryption directory that contain datapacks and mappack info if there are any.

---

After decrypting the datapacks, the server will simply listen for any requests from the app it can fulfill

---

### Decrypter

The TSC Online platform uses a specific JAR file, named `datapack-decrypter_DDMMMYYYY.jar`, to decrypt encrypted datapacks during server startup. For instance, a typical JAR file might be named `datapack-decrypter_21Jun2024.jar`.

To ensure the server starts correctly, this JAR file must be placed in the `tsconline/server/assets/jars` directory alongside the active server JAR file. Additionally, the JAR file and its input arguments should be specified in the `tsconline/server/assets/admin-config.json` file.


##### Example Usage
To invoke the decryption process using the JAR file, you can use a command like the following:

```
const cmd = 
    `java -jar ${assetconfigs.decryptionJar} ` + 
    `-d ${datapackPaths.join(" ")} ` + 
    `-dest ${assetconfigs.decryptionDirectory} `;
```

#### Arguments
- **`-d <file1> <file2> ...`**: Specifies one or more datapack files to decrypt. These files can have extensions such as `.dpk`, `.txt`, `.mdpk`, or `.map`.
- **`-dest <directory>`**: Specifies the destination directory where the decrypted files should be stored. If the directory does not exist, it will be created automatically. The program also manages version control within this directory.
- **`-h`**: Displays a help message detailing how to use the program, including descriptions of the available arguments.


#### Output
- **Decrypted Files**: The program saves the decrypted content of the datapack files in the specified destination directory. If the datapacks are ZIP archives, the program will extract and process the files contained within.
  
- **Version Control**: The program creates a `version.info` file in the destination directory to store the version number of the decryption script. This mechanism ensures changes in the decryption program will cause the server to redecrypt the datapacks.

- **Error Handling**: If any errors occur during decryption or extraction, the program logs the errors and deletes any partially processed files to prevent corrupted data from being left in the destination directory.


#### Version Control of Decryptionn on Server Startup
The decryption program checks for a version.info file in the destination directory. If the version in this file matches the version in the program, the program will skip redecrypting the datapacks. However, if the version is different or the version.info file does not exist, the program will proceed with decrypting the datapacks.


#### Modifying the Decryption Program
The decryption program's source code is stored in Bitbucket.

When making any changes to the decryption program, it is crucial to update the version_number string by incrementing it by 0.01.

For example, if the current version is:
```
private static String version_number = "1.00";
```
Change it to:
```
private static String version_number = "1.01";
```

This ensures that the new decryption JAR will redecrypt the datapacks using the updated logic.


#### Building the JAR
The decryption jar can be created from the datapack-decrypter Java program repository stored on Bitbucket by using Maven.

First, clone this repository, then in the working directory, use Maven to compile the program into a Jar.

Check Maven Installation:
```
mvn -v
```
If Maven is not installed, run the following commands:

```
sudo apt update
sudo apt install maven
```

Build the JAR:
While in the directory containing the pom.xml file, run:

```
mvn clean install
```

This will create a decryption JAR file inside the `/target` folder with the date appended to the filename, such as:
`datapack-decrypter_21Jun2024.jar`

Note on JAR Naming
The date appended to the JAR file's name is for informational purposes only and has no impact on the version control mechanism. This date helps users identify when the file was last changed. Remember, after building the new JAR, update the admin-config.json file to reference the correct JAR, as the filename will have changed.

---

### Admin Config

The server holds `DatapackMetadata` which describes multiple facets and characteristics of the datapacks. See below

```js
export type DatapackMetadata = {
  description: string,
  title: string,
  file: string,
  size: string,
  date?: string,
  authoredBy: string,
  tags: string[],
  references: string[],
  contact?: string,
  notes?: string,
};
```

However, we want to keep the repo a shell. This means that the repo will not contain any predetermined datapacks. The server will then have a .gitignored `admin-config.json` that will hold all the metadata for the datapacks. This will be used to populate the `DatapackMetadata` for the server.

The config that we have on command if we want to populate it is stored in `dev-config.json`. This is the config that we will use to populate the `admin-config.json` file.

To run this you will run `yarn dev:config` in `server`.

This will run a script to add the datapack metadata in `dev-config.json` to `admin-config.json`. This will **NOT** add any datapacks to `asset/datapacks` or `assets/decrypted`.

You will need to download the datapacks yourself and run `yarn start` to decrypt them properly (assuming the files are correct)

## File Metadata

The server will store the metadata of any uploaded files in `file-metdata.json` in `server/assets`.

This metadata will be in the form

```js
export type FileMetadataIndex = {
  [filepath: string]: FileMetadata,
};
export type FileMetadata = {
  fileName: string,
  lastUpdated: string,
  decryptedFilepath: string,
  mapPackIndexFilepath: string,
  datapackIndexFilepath: string,
};
```

This is done so that we can easily access when the file was last used/updated and where all its information is stored. Once `lastUpdated` becomes stale (after 2 weeks) the server will delete the file and its metadata.

This is **NOT** to be confused with `DatapackMetadata` which is specifically for characterizing the datapacks and map packs.

**NOTE**: If the file is updated when a user uses it for chart generation and the server's `FileMetadata` does not have an entry for that uploaded file, an error is thrown. Therefore, if the file exists and is not in metadata, manual cleanup is required. However, if the file does not exist and the metadata says that it exists, the server will check it's existence and remove the metadata if it does not exist.

## Notes on all routes:
- Many routes have rate limits added to them. These rate limits are based on IP addresses and we store in the database a track of IP addresses that have been rate limited. Every Sunday at midnight this list is sent to our main email address and these entries are cleared from the database.

## User Endpoints

### Fetch Chart

- **Endpoint:** `/charts`
- **Method:** `POST`
- **Description:** Fetch the chart image for the given settings and datapacks
- **Requires Valid Session:** No

#### Request Body

| Name      | Type    | Description                                                                                    | Required |
| --------- | ------- | ---------------------------------------------------------------------------------------------- | -------- |
| settings  | string  | The settings for the chart in xml format.                                                      | Yes      |
| datapacks | string  | The datapacks to use for the chart.                                                            | Yes      |
| useCache  | boolean | Whether to use the cache or not. If `true`, the server will use the cached chart if it exists. | Yes      |

#### Example Request

```http
POST /charts/false HTTP/1.1
Content-Type: application/json
Host: dev.timescalecreator.org
{
  "settings": "<xml>[settings]</xml>",
  "datapacks": ["datapack1", "datapack2"],
  "useCache": true
}
```

#### Example Response

```json
{
  "chart": "https://dev.timescalecreator.org/charts/72309213/chart.png"
}
```

#### Error Responses

- **Status Code:** `400 Bad Request`
- **Content-Type:** `application/json`
- **Description:** Returned if the request body is invalid

```json
{
  "error": "ERROR: chart request is not valid. Error was: ..."
}
```

- **Status Code:** `503 Service Unavailable`
- **Content-Type:** `application/json`
- **Description:** If the queue is full, the server will return this error (IMPORTANT because the java file takes around 2GB of RAM and server is limited to ~16 GB at the moment)

```json
{
  "error": "Server is too busy. Please try again later."
}
```

- **Status Code:** `408 Request Timeout`
- **Content-Type:** `application/json`
- **Description:** Returned if the chart generation takes too long

```json
{
  "error": "Request timed out"
}
```

- **Status Code:** `500 Internal Server Error`
- **Content-Type:** `application/json`
- **Description:** Returned if the server encounters an error while generating the chart. Could also return if the server is unable to save the chart, or the java file failed.

```json
{
  "error": "Internal server error"
}
```

---

### Fetch Timescale

- **Endpoint:** `/timescale`
- **Method:** `GET`
- **Description:** Fetch the timescale data that holds all the ages/stages of Earth
- **Requires Valid Session:** No

#### Example Request

```http
GET /timescale HTTP/1.1
Host: dev.timescalecreator.org
```

#### Example Response

```json
{
  "timescaleData": [
    {
      "key": "Holocene",
      "value": 0
    },
    {
      "key": "Lt. Pleistocene",
      "value": 0.126
    }
  ]
}
```

#### Error Responses

- **Status Code:** `500 Internal Server Error`
- **Content-Type:** `application/json`
- **Description:** Returned if the server encounters an error while fetching the timescale data or it cannot read the excel file

```json
{
  "error": "Internal server error"
}
```

- **Status Code:** `404 Not Found`
- **Content-Type:** `application/json`
- **Description:** Returned if the server cannot find the excel file

```json
{
  "error": "Excel file not found"
}
```

---

### Facies Patterns

- **Endpoint:** `/facies-patterns`
- **Method:** `GET`
- **Description:** Fetch the facies patterns data that holds all the facies patterns (loaded on server startup)
- **Requires Valid Session:** No

#### Example Request

```http
GET /facies-patterns HTTP/1.1
Host: dev.timescalecreator.org
```

#### Example Response

```json
{
  "patterns": {
    ["Limestone"]: {
      "name": "Limestone",
      "formattedName": "Limestone",
      "filepath": "public/facies-patterns/Limestone.png",
      "color": {
        "name": "Red",
        "hex": "#FF0000",
        "rgb": "rgb(255, 0, 0)"
      }
    },
    ["Sandstone"]: {
      "name": "Sandstone",
      "formattedName": "Sandstone",
      "filepath": "public/facies-patterns/Sandstone.png",
      "color": {
        "name": "Green",
        "hex": "#00FF00",
        "rgb": "rgb(0, 255, 0)"
      }
    }
  }
}
```

#### Error Responses

- **Status Code:** `500 Internal Server Error`
- **Content-Type:** `application/json`
- **Description:** Returned if the server doesn't load the facies patterns on startup

```json
{
  "error": "Servver isn't able to load facies patterns"
}
```

---

### Fetch Image

- **Endpoint:** `/images/:datapackName/:imageName`
- **Method:** `GET`
- **Description:** Fetch the image for the given datapack and image name

#### Parameters

| Name         | Type   | Description              | Required |
| ------------ | ------ | ------------------------ | -------- |
| datapackName | string | The name of the datapack | Yes      |
| imageName    | string | The name of the image    | Yes      |

#### Example Request

```http
GET /images/TSC2020/image.png HTTP/1.1
Host: dev.timescalecreator.org
```

#### Example Response

```json
{
  "image": "images/TSC2020/image.png"
}
```

#### Error Responses

- **Status Code:** `404 Not Found`
- **Content-Type:** `application/json`
- **Description:** Returned if the server cannot find the image

```json
{
  "error": "Image not found"
}
```

- **Status Code:** `403 Forbidden`
- **Content-Type:** `application/json`
- **Description:** Returned if the filepath goes outside the allowed directory

```json
{
  "error": "Invalid image path"
}
```

---

### User Datapacks

- **Endpoint:** `/user-datapacks`
- **Method:** `GET`
- **Description:** Fetch the user's datapacks
- **Requires Valid Session:** Yes

#### Example Request

```http
GET /user-datapacks HTTP/1.1
Host: dev.timescalecreator.org
Cookie: loginSession=123
```

#### Example Response

```json
{
  "datapackIndex": {
    ["TSC2020"]: {
      "<DatapackParsingPack>"
    },
    ["TSC2021"]: {
      "<DatapackParsingPack>"
    }
  },
  "mapPackIndex": {
    ["TSC2020"]: {
      "<MapPack>"
    },
    ["TSC2021"]: {
      "<MapPack>"
    }
  }
}
```

#### Error Responses

- **Status Code:** `401 Unauthorized`
- **Content-Type:** `application/json`
- **Description:** Returned if the user is not logged in

```json
{
  "error": "User not logged in"
}
```

- **Status Code:** `404 Not Found`
- **Content-Type:** `application/json`
- **Description:** Returned if the user has no datapacks

```json
{
  "error": "User has no uploaded datapacks"
}
```

- **Status Code:** `500 Internal Server Error`
- **Content-Type:** `application/json`
- **Description:** Returned if the server encounters an error while fetching and/or reading the user's datapacks

```json
{
  "error": "Failed to load indexes, corrupt json files present. Please contact customer service."
}
```

---

### Server Datapack Info (Chunks)

- **Endpoint:** `/datapack-index`
- **Method:** `GET`
- **Description:** Fetch the server's datapack info (in chunks)
- **Requires Valid Session:** No
- **Note:** This is used to fetch all the datapacks on the server in chunks. The server will return the total number of chunks and the datapacks in the requested chunk. Chunks are requested by the `start` and `increment` query parameters. They also signify datapacks to fetch (one datapack = one chunk).

#### Query Parameters

| Name      | Type   | Description                                             | Required |
| --------- | ------ | ------------------------------------------------------- | -------- |
| start     | number | The starting index of the chunk to fetch (default is 0) | No       |
| increment | number | The increment of the chunk to fetch (default is 1)      | No       |

#### Example Request

```http
GET /datapack-index?start=0&increment=1 HTTP/1.1
Host: dev.timescalecreator.org
```

#### Example Response

```json
{
  "datapackIndex": {
    ["TSC2020"]: {
      "<DatapackParsingPack>"
    }
  },
  "totalChunks": 10
}
```

#### Error Responses

- **Status Code:** `500 Internal Server Error`
- **Content-Type:** `application/json`
- **Description:** Returned if the server encounters an error while fetching and/or reading the datapacks

```json
{
  "error": "Failed to load datapack"
}
```

- **Status Code:** `404 Not Found`
- **Content-Type:** `application/json`
- **Description:** Returned if the server has no datapacks at the requested chunks

```json
{
  "error": "No datapacks found"
}
```

---

### Server MapPack Info (Chunks)

- **Endpoint:** `/map-pack-index`
- **Method:** `GET`
- **Description:** Fetch the server's map pack info (in chunks)
- **Requires Valid Session:** No
- **Note:** This is used to fetch all the map packs on the server in chunks. The server will return the total number of chunks and the map packs in the requested chunk. Chunks are requested by the `start` and `increment` query parameters. They also signify map packs to fetch (one map pack = one chunk).

#### Query Parameters

| Name      | Type   | Description                                             | Required |
| --------- | ------ | ------------------------------------------------------- | -------- |
| start     | number | The starting index of the chunk to fetch (default is 0) | No       |
| increment | number | The increment of the chunk to fetch (default is 1)      | No       |

#### Example Request

```http
GET /map-pack-index?start=0&increment=1 HTTP/1.1
Host: dev.timescalecreator.org
```

#### Example Response

```json
{
  "mapPackIndex": {
    ["TSC2020"]: {
      "<MapPack>"
    }
  },
  "totalChunks": 10
}
```

#### Error Responses

- **Status Code:** `500 Internal Server Error`
- **Content-Type:** `application/json`
- **Description:** Returned if the server encounters an error while fetching and/or reading the map packs

```json
{
  "error": "Failed to load map pack"
}
```

- **Status Code:** `404 Not Found`
- **Content-Type:** `application/json`
- **Description:** Returned if the server has no map packs at the requested chunks

```json
{
  "error": "No map packs found"
}
```

---

### Remove Cache

- **Endpoint:** `/removecache`
- **Method:** `POST`
- **Description:** Removes the cache for the charts
- **Requires Valid Session:** No

#### Example Request

```http
POST /removecache HTTP/1.1
Host: dev.timescalecreator.org
```

#### Example Response

```json
{
  "message": "Directory public/charts successfully deleted"
}
```

---

### Svg Status

- **Endpoint:** `/svgstatus/:hash`
- **Method:** `GET`
- **Description:** Check the readiness of the svg file identified by the hash
- **Requires Valid Session:** No

#### Parameters

| Name | Type   | Description          | Required |
| ---- | ------ | -------------------- | -------- |
| hash | string | Hash of the svg file | Yes      |

#### Example Request

```http
POST /svgstatus/72309213 HTTP/1.1
Host: dev.timescalecreator.org
```

#### Example Response

```json
{
  "ready": true
}
```

#### Error Responses

- **Status Code:** `403 Forbidden`
- **Content-Type:** `application/json`
- **Description:** Returned if the hash is invalid or the filepath goes outside the allowed directory

```json
{
  "message": "Invalid hash"
}
```

- **Status Code:** `404 Not Found`
- **Content-Type:** `application/json`
- **Description:** Returned if no directory is found for the hash

```json
{
  "message": "No directory exists at hash: 72309213"
}
```

### Fetch Settings XML

- **Endpoint:** `/settingsXml/:file`
- **Method:** `GET`
- **Description:** Fetch the settings xml file requested
- **Requires Valid Session:** No

#### Parameters

| Name | Type   | Description               | Required |
| ---- | ------ | ------------------------- | -------- |
| file | string | Name of the settings file | Yes      |

#### Example Request

```http
GET /settingsXml/public/presets/001-TSC2020/settings.xml HTTP/1.1
Host: dev.timescalecreator.org
```

#### Example Response

```xml
<?xml version="1.0" encoding="UTF-8"?>
<settings>
  <setting>
    <name>setting1</name>
    <value>value1</value>
  </setting>
  <setting>
    <name>setting2</name>
    <value>value2</value>
  </setting>
```

#### Error Responses

- **Status Code:** `404 Not Found`
- **Content-Type:** `application/json`
- **Description:** Returned if the file is not found

```json
{
  "error": "File not found"
}
```

---

### Download User-Datapacks

- **Endpoint:** `/user/datapack/:filename`
- **Method:** `GET`
- **Description:** Download the user's datapacks. If the user chooses `Encrypted Download`, the encrypted file will be downloaded. Otherwise, the original file will be downloaded.
- **Requires Valid Session:** Yes

#### Parameter

| Name     | Type   | Description                                      | Required |
| -------- | ------ | ------------------------------------------------ | -------- |
| filename | string | The name of the file that needs to be downloaded | Yes      |

#### Query Parameter

| Name           | Type    | Description                      | Required |
| -------------- | ------- | -------------------------------- | -------- |
| needEncryption | boolean | Whether need to encrypt the file | No       |

#### Example Request

```http
GET /user/datapack/defaultDatapack?needEncryption=true HTTP/1.1
Host: dev.timescalecreator.org
Cookie: loginSession=123
```

#### Example Response

```blob
  <Binary data of the file>
```

#### Error Responses

- **Status Code:** `401 Unauthorized`
- **Content-Type:** `application/json`
- **Description:** Returned if the user is not logged in

```json
{
  "error": "User not logged in"
}
```

- **Status Code:** `403 Forbidden`
- **Content-Type:** `application/json`
- **Description:** Returned if the filepath is not valid

```json
{
  "error": "Invalid file path"
}
```

- **Status Code:** `404 Not Found`
- **Content-Type:** `application/json`
- **Description:** Returned if the file requested is not found

```json
{
  "error": "The file requested <filename> does not exist within user's upload directory"
}
```

- **Status Code:** `500 Internal Server Error`
- **Content-Type:** `application/json`
- **Description:** Returned if the encryption process failed

```json
{
  "error": "Failed to encrypt datapacks with error <error>"
}
```

- **Status Code:** `500 Internal Server Error`
- **Content-Type:** `application/json`
- **Description:** Returned if failed to create encrypted directory for the user

```json
{
  "error": "Failed to create encrypted directory with error <error>"
}
```

- **Status Code:** `422 Unprocessable Content`
- **Content-Type:** `application/json`
- **Description:** Returned if Java file failed to generate the correct encrypted file

```json
{
  "error": "Java file was unable to encrypt the file <filename>, resulting in an incorrect encryption header"
}
```

---

## Admin Endpoints

This section will detail all the admin endpoints that are available to the admin user. All these endpoints require a valid session to be used and a recaptcha token to be passed in the headers.

### General Request Headers/Requirements for the route

| Name      | Type   | Description                                                                                                       | Required |
| --------- | ------ | ----------------------------------------------------------------------------------------------------------------- | -------- |
| recaptcha | string | The recaptcha token to verify the user is not a bot.                                                              | Yes      |
| session   | string | The session token to verify the user is logged in. which will also connect the user to their uuid in the database | Yes      |

### Example Base Request

```http
POST /admin/users HTTP/1.1
Host: dev.timescalecreator.org
recaptcha: 123
Cookie: loginSession=123
```

### General Error Responses

- **Status Code:** `401 Unauthorized`
- **Content-Type:** `application/json`
- **Description:** Returned if the user is not an admin, not an existing user, or the session is invalid/nonexistent

```json
{
  "error": "Unauthorized Access"
}
```

- **Status Code:** `400 Bad Request`
- **Content-Type:** `application/json`
- **Description:** Returned if the request header is missing the recaptcha token

```json
{
  "error": "Missing recaptcha token"
}
```

- **Status Code:** `422 Unprocessable Entity`
- **Content-Type:** `application/json`
- **Description:** Returned if the recaptcha token is invalid

```json
{
  "error": "Recaptcha failed"
}
```

---

### Fetch Users

- **Endpoint:** `/admin/users`
- **Method:** `POST`
- **Description:** Fetch all the users
- **Requires Valid Session:** Yes
- **NOTE** We choose POST so we have more data available to send as the user's increase (GET requests are limited compared to POST)

#### Example Request

```http
POST /admin/users HTTP/1.1
Host: dev.timescalecreator.org
recaptcha: 123
Cookie: loginSession=123
```

#### Example Response

```json
{
  "users": [
    {
      "uuid": "123",
      "userId": "user1",
      "email": "user@gmail.com",
      "username": "user1",
      "emailVerified": true,
      "invalidateSession": false,
      "isGoogleUser": false,
      "isAdmin": false,
      "pictureUrl": "https://www.google.com"
    }
  ]
}
```

---

### Create User

- **Endpoint:** `/admin/user`
- **Method:** `POST`
- **Description:** Create a user
- **Requires Valid Session:** Yes

#### Request Body

| Name       | Type    | Description                                        | Required |
| ---------- | ------- | -------------------------------------------------- | -------- |
| email      | string  | The email for the user                             | Yes      |
| password   | string  | The password for the user                          | Yes      |
| username   | string  | The username for the user                          | No       |
| pictureUrl | string  | The picture url for the user                       | No       |
| isAdmin    | boolean | Whether the user is an admin (Defaults to "false") | No       |

#### Example Request

```http
POST /admin/user HTTP/1.1
Host: dev.timescalecreator.org
recaptcha: 123
Cookie: loginSession=123
{
  "username": "user1",
  "password": "password1",
  "email": "email1",
  "pictureUrl": "google.com",
  "isAdmin": "true"
}
```

#### Example Response

```json
{
  "message": "User created"
}
```

#### Error Responses

- **Status Code:** `400 Bad Request`
- **Content-Type:** `application/json`
- **Description:** Returned if the request body is invalid

```json
{
  "error": "Missing/invalid required fields"
}
```

- **Status Code:** `409 Conflict`
- **Content-Type:** `application/json`
- **Description:** Returned if the user already exists

```json
{
  "error": "User already exists"
}
```

### Delete User

- **Endpoint:** `/admin/user`
- **Method:** `DELETE`
- **Description:** Delete a user
- **Requires Valid Session:** Yes

#### Request Body

| Name | Type   | Description                        | Required |
| ---- | ------ | ---------------------------------- | -------- |
| uuid | string | The uuid of the user to be deleted | Yes      |

#### Example Request

```http
DELETE /admin/user HTTP/1.1
Host: dev.timescalecreator.org
recaptcha: 123
Cookie: loginSession=123
{
  "uuid": "123"
}
```

#### Example Response

```json
{
  "message": "User deleted"
}
```

#### Error Responses

- **Status Code:** `400 Bad Request`
- **Content-Type:** `application/json`
- **Description:** Returned if the request body is invalid

```json
{
  "error": "Missing uuid"
}
```

- **Status Code:** `404 Not Found`
- **Content-Type:** `application/json`
- **Description:** Returned if the user does not exist

```json
{
  "error": "User does not exist"
}
```

- **Status Code:** `403 Forbidden`
- **Content-Type:** `application/json`
- **Description:** Cannot delete the root user

```json
{
  "error": "Cannot delete root user"
}
```

### Delete User Datapack

- **Endpoint:** `/admin/user/datapack`
- **Method:** `DELETE`
- **Description:** Delete a user's datapack
- **Requires Valid Session:** Yes

#### Request Body

| Name     | Type   | Description                     | Required |
| -------- | ------ | ------------------------------- | -------- |
| datapack | string | The datapack                    | Yes      |
| uuid     | string | The uuid of the datapack's user | Yes      |

#### Example Request

```http
DELETE /admin/user/datapack HTTP/1.1
Host: dev.timescalecreator.org
recaptcha: 123
Cookie: loginSession=123
{
  "datapack": "datapack1",
  "uuid": "123"
}
```

#### Example Response

```json
{
  "message": "Datapack deleted"
}
```

#### Error Responses

- **Status Code:** `400 Bad Request`
- **Content-Type:** `application/json`
- **Description:** Returned if the request body is invalid

```json
{
  "error": "Missing uuid or datapack id"
}
```

- **Status Code:** `404 Not Found`
- **Content-Type:** `application/json`
- **Description:** Returned if the datapack does not exist

```json
{
  "error": "Datapack not found"
}
```

### Upload Server Datapack

- **Endpoint:** `/admin/server/datapack`
- **Method:** `POST`
- **Description:** Upload a server datapack
- **Requires Valid Session:** Yes

#### Request Body -> **_Multipart Form Data_**

| Name        | Type   | Description                                               | Required |
| ----------- | ------ | --------------------------------------------------------- | -------- |
| file        | file   | The datapack file to upload                               | Yes      |
| tags        | string | The tags for the datapack                                 | Yes      |
| references  | string | The references for the datapack                           | Yes      |
| authoredBy  | string | The author of the datapack                                | Yes      |
| title       | string | The title of the datapack                                 | Yes      |
| description | string | The description of the datapack                           | Yes      |
| date        | string | The date of the datapack (a valid date string DD/MM/YYYY) | No       |
| contact     | string | The contact for the datapack                              | No       |
| notes       | string | The notes for the datapack                                | No       |

#### Example Request

```http
POST /admin/server/datapack HTTP/1.1
Host: dev.timescalecreator.org
recaptcha: 123
Cookie: loginSession=123
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW
{
  "file": "datapack1",
  "tags": "tag1, tag2",
  "references": "ref1, ref2",
  "authoredBy": "author1",
  "title": "title1",
  "description": "description1",
  "date": "date1",
  "contact": "contact1",
  "notes": "notes1"
}
```

#### Example Response

```json
{
  "message": "Datapack uploaded"
}
```

#### Error Responses

- **Status Code:** `400 Bad Request`
- **Content-Type:** `application/json`
- **Description:** Returned if the request body is invalid

```json
{
  "error": "Missing required fields [title, description, authoredBy, references, tags, filepath, filename]"
}
```

```json
{
  "error": "File is empty"
}
```

```json
{
  "error": "References and tags must be valid arrays"
}
```

```json
{
  "error": "Date must be a valid date string"
}
```

```json
{
  "error": "Invalid file type"
}
```

- **Status Code:** `409 Conflict`
- **Content-Type:** `application/json`
- **Description:** Returned if the datapack already exists

```json
{
  "error": "File already exists"
}
```

### Delete Server Datapack

- **Endpoint:** `/admin/server/datapack`
- **Method:** `DELETE`
- **Description:** Delete a server datapack
- **Requires Valid Session:** Yes

#### Request Body

| Name     | Type   | Description                | Required |
| -------- | ------ | -------------------------- | -------- |
| datapack | string | The datapack to be deleted | Yes      |

#### Example Request

```http
DELETE /admin/server/datapack HTTP/1.1
Host: dev.timescalecreator.org
recaptcha: 123
Cookie: loginSession=123
{
  "datapack": "datapack1"
}
```

#### Example Response

```json
{
  "message": "Datapack <datapack> deleted"
}
```

#### Error Responses

- **Status Code:** `400 Bad Request`
- **Content-Type:** `application/json`
- **Description:** Returned if the request body is invalid

```json
{
  "error": "Missing datapack id"
}
```

```json
{
  "error": "Invalid file extension"
}
```

- **Status Code:** `500 Internal Server Error`
- **Content-Type:** `application/json`
- **Description:** Returned if the server encounters an error while deleting the datapack

```json
{
  "error": "Failed to delete datapack"
}
```

- **Status Code:** `500 Internal Server Error`
- **Content-Type:** `application/json`
- **Description:** Returned if the server encounters an error while deleting the datapack

```json
{
  "error": "Failed to delete datapack"
}
```

- **Status Code:** `500 Internal Server Error`
- **Content-Type:** `application/json`
- **Description:** Returned if the server encounters an error while deleting the datapack

```json
{
  "error": "Failed to delete datapack"
}
```

- **Status Code:** `500 Internal Server Error`
- **Content-Type:** `application/json`
- **Description:** Returned if the server encounters an error while deleting the datapack

```json
{
  "error": "Failed to delete datapack"
}
```

- **Status Code:** `500 Internal Server Error`
- **Content-Type:** `application/json`
- **Description:** Datapack file does not exist

```json
{
  "error": "Datapack file does not exist"
}
```

- **Status Code:** `404 Not Found`
- **Content-Type:** `application/json`
- **Description:** Returned if the datapack does not exist

```json
{
  "error": "Datapack not found"
}
```

### Fetch all User Datapacks

- **Endpoint:** `/admin/user/datapacks`
- **Method:** `POST`
- **Description:** Fetch all the user's datapacks
- **Requires Valid Session:** Yes

#### Request Body

| Name | Type   | Description          | Required |
| ---- | ------ | -------------------- | -------- |
| uuid | string | The uuid of the user | Yes      |

#### Example Request

```http
POST /admin/user/datapacks HTTP/1.1
Host: dev.timescalecreator.org
recaptcha: 123
Cookie: loginSession=123
{
  "uuid": "123"
}
```

#### Example Response

```json
{
  "datapacks": [
    {
      "description": "description1",
      "title": "title1",
      "file": "file1",
      "size": "size1",
      "date": "date1",
      "authoredBy": "authoredBy1",
      "tags": ["tag1", "tag2"],
      "references": ["ref1", "ref2"],
      "contact": "contact1",
      "notes": "notes1"
    }
  ]
}
```

#### Error Responses

- **Status Code:** `400 Bad Request`
- **Content-Type:** `application/json`
- **Description:** Returned if the request body is invalid

```json
{
  "error": "Missing uuid in body"
}
```

---

#### Parse Datapacks

For all the datapacks in the paramaters return all the column data and any map data along with that. The datapack parsing takes place in `src/parse.ts`.

**_TODO: check if the files passed in the params even exist. What should be the intended action after?_**

We parse the tab indented datapack and fill the data type `ColumnInfo`

```js
export type ColumnInfo = {
  [name: string]: {
    on: boolean,
    children: ColumnInfo | null,
    parents: string[],
  },
};
```

For reference the datapack will consist of parents and children formatted such as

```text
<parents>\t:\t<child>\t<child>\t<child>...
```

Where children can be parents at some point.

General summary of the parsing is as follows:

1. Find all `parents` and `children` and put the pairs in a set called allEntries indexed by `parents`. `children` will be an array of `child`'s that are strings.

2. Iterate over all `parents` keys and for all children put them into a set called `isChild`. This will hold all children that are or will be children.

3. Iterate over `allEntries` keys but skip if the key is in `isChild`. For every key that "isn't" a child, run the recursive function that creates a ColumnInfo variable for the parent and recursively calls for all the children

These steps allow us to create the ColumnInfo variables without any dupes or complications.

#### Parse Mappacks

If the file has any map pack info, the function `grabMapInfo` will parse the required files and create `MapInfo` variables with the information.

```js
export type MapInfo = {
  [name: string]: {
    img: string,
    note?: string,
    parent?: MapInfo[string],
    coordtype: string,
    bounds: Bounds,
    mapPoints: MapPoints,
  },
};
```

**_Currently the MapInfo variable is only working with `Rectangular Coordinates`_**

The decrypt.jar will create in every successful decryption of a datapack a mappack directory that contains any mappack info. If this exists for the datapacks requested, `grabMapInfo` will process it and aggregate it for all the datapacks involved.

The mappack is formatted like

![mappack](assets/Map-Example.png)

Parsing this is more or less self explanatory. The one nuance that comes up are some of the settings can be present while some do not have to such as note and parent. `Parent` would exist if there is a parent map for the current map we are on. To accomodate these possibilities we parse the names found in the header. We know it's a header if it contains `HEADER` at the beginning. Using these labels at the top as the keys we can create a switch statement that checks all the labels that we know exist.

This same parsing idea is used to fill out MapPoints.

```js
export type MapPoints = {
  [name: string]: {
    lat: number,
    lon: number,
    default?: string,
    minage?: number,
    maxage?: number,
    note?: string,
  },
};
```

This data structure is for the buttons that represent columns on the map itself.

## Login Routes

### Notes on Login Routes:
- For the login routes the error responses will not be included as there are too many. To see the routes' error responses in full detail refer to the flowchart at the end of this section.
- Tokens that are generated by the server and sent through links are utilized in many of the following routes. These tokens can pile up in the database so every week (from when the server starts) tokens that have expired are deleted.

---

### Google Login

- **Endpoint:** `/auth/oauth`
- **Method:** `POST`
- **Description:** Login using google oauth

#### Request Body

| Name           | Type   | Description                                     | Required |
| -------------- | ------ | ----------------------------------------------- | -------- |
| credential     | string | The id token associated with the google account | Yes      |
| recaptchaToken | string | The recaptcha token to verify the user is real  | Yes      |

#### Example Request

```http
POST /auth/oauth
credentials: include
Host: dev.timescalecreator.org
{
  "credential": "1230a9s8dfa0",
  "recaptchaToken": "123"
}
```

#### Success Response

On success, the session is set for the user.

---

### User/Pass Login

- **Endpoint:** `/auth/login`
- **Method:** `POST`
- **Description:** Login using user/pass

#### Request Body

| Name           | Type   | Description                                     | Required |
| -------------- | ------ | ----------------------------------------------- | -------- |
| username       | string | The username of the user                        | Yes      |
| password       | string | The password of the user                        | Yes      |
| recaptchaToken | string | The recaptcha token to verify the user is real  | Yes      |

#### Example Request

```http
POST /auth/login
credentials: include
Host: dev.timescalecreator.org
{
  "username": "username",
  "password": "password",
  "recaptchaToken": "123"
}
```

#### Success Response

On success, the session is set for the user.

---

### Signup

- **Endpoint:** `/auth/signup`
- **Method:** `POST`
- **Description:** Sign up using user/pass

#### Request Body

| Name           | Type   | Description                                     | Required |
| -------------- | ------ | ----------------------------------------------- | -------- |
| username       | string | The username of the user                        | Yes      |
| password       | string | The password of the user                        | Yes      |
| email          | string | The email    of the user                        | Yes      |
| recaptchaToken | string | The recaptcha token to verify the user is real  | Yes      |

#### Example Request

```http
POST /auth/oauth
Host: dev.timescalecreator.org
{
  "username": "username",
  "password": "password",
  "email": "email@gmail.com",
  "recaptchaToken": "123"
}
```

#### Success Response

On success, an email is sent to the user containing a link with a randomly generated token that will be later used to verify that the user actually owns that email.

---

### Resend Verification Email

- **Endpoint:** `/auth/resend`
- **Method:** `POST`
- **Description:** Resend verification email sent in previous route.

#### Request Body

| Name           | Type   | Description                                     | Required |
| -------------- | ------ | ----------------------------------------------- | -------- |
| email          | string | The id token associated with the google account | Yes      |
| recaptchaToken | string | The recaptcha token to verify the user is real  | Yes      |

#### Example Request

```http
POST /auth/resend
Host: dev.timescalecreator.org
{
  "email": "email@gmail.com",
  "recaptchaToken": "123"
}
```

#### Success Response

On success, an email is sent to the user containing a link with a randomly generated token (expiring in 1 hour) that will be later used to verify that the user actually owns that email.

---

### Verify Email

- **Endpoint:** `/auth/verify`
- **Method:** `POST`
- **Description:** Verify that the user owns the email address they attempted to sign up with. This is meant to only be accessed through the link in an email.

#### Request Body

| Name           | Type   | Description                                                                       | Required |
| -------------- | ------ | --------------------------------------------------------------------------------- | -------- |
| token          | string | The randomly genereatd token by the server that was in the link sent in the email | Yes      |

#### Example Request

```http
POST /auth/resend
credentials: include
Host: dev.timescalecreator.org
{
  "token": "123"
}
```

#### Success Response

On success, the session is set for the user.

---

### Send Forgot Password Email

- **Endpoint:** `/auth/send-forgot-password-email`
- **Method:** `POST`
- **Description:** Send a forgot password email. If the user is a google user it will send them an email notifying them, otherwise it will send them a link to reset their password.

#### Request Body

| Name           | Type   | Description                                     | Required |
| -------------- | ------ | ----------------------------------------------- | -------- |
| email          | string | The id token associated with the google account | Yes      |
| recaptchaToken | string | The recaptcha token to verify the user is real  | Yes      |

#### Example Request

```http
POST /auth/send-forgot-password-email
Host: dev.timescalecreator.org
{
  "email": "email@gmail.com",
  "recaptchaToken": "123"
}
```

#### Success Response

On success, an email is sent to the user containing a link with a randomly generated token (expiring in 15 minutes) that will be later used to verify the user and allow them to change their email.

---

### Forgot Password

- **Endpoint:** `/auth/forgot-password`
- **Method:** `POST`
- **Description:** Verify the token in the email sent by the previous route and change the password of the user.

#### Request Body

| Name           | Type   | Description                                                                        | Required |
| -------------- | ------ | ---------------------------------------------------------------------------------- | -------- |
| token          | string | The randomly genereatd token by the server that was in the link sent in the email  | Yes      |
| password       | string | The updated password of the user                                                   | Yes      |
| recaptchaToken | string | The recaptcha token to verify the user is real                                     | Yes      |

#### Example Request

```http
POST /auth/forgot-password
credentials: include
Host: dev.timescalecreator.org
{
  "token": "1234",
  "password": "newPassword",
  "recaptchaToken": "123"
}
```

#### Success Response

On success, the session is set for the user.

---

### Change Email

- **Endpoint:** `/auth/change-email`
- **Method:** `POST`
- **Description:** Sends an email to the user's new email with a verification link. Also sends an email to their old email alerting them of the email change. If this is for a Google user, it also changes their account to a user/pass account by assigning a temporary password.
- **Requires Valid Session:** Yes

#### Request Body

| Name           | Type   | Description                                     | Required |
| -------------- | ------ | ----------------------------------------------- | -------- |
| newEmail       | string | The new email for the user                      | Yes      |
| recaptchaToken | string | The recaptcha token to verify the user is real  | Yes      |

#### Example Request

```http
POST /auth/change-email
Host: dev.timescalecreator.org
Cookie: loginSession=123
{
  "newEmail": "new@gmail.com",
  "recaptchaToken": "123"
}
```

#### Success Response

On success, an email is sent to the user's old email with a link to recover their account with a randomly generated token (expiring in 24 hours) if they didn't initiate the email change. Another email is sent to their new email address containing the normal verification email to verify their new email address. If their new email is the same as their old email, an email is sent notifying them of this.

---

### Account Recovery

- **Endpoint:** `/auth/account-recovery`
- **Method:** `POST`
- **Description:** This route is accessed through the link sent to their old email address in the previous route. This route will set the user's session to invalid in the database (to invalidate any further uses of that session) and the user will be sent an email that follows the forgot password flow which will validate their session in the database. The user is also assigned a random password. These together make it so that the account is locked down until the user changes their password by following the link in the email.

#### Request Body

| Name           | Type   | Description                                                                         | Required |
| -------------- | ------ | ----------------------------------------------------------------------------------- | -------- |
| token          | string | The randomly genereatd token by the server that was in the link sent in the email   | Yes      |
| email          | string | The old email of the user. This is stored in the link that is sent in the email     | Yes      |

#### Example Request

```http
POST /auth/account-recovery
Host: dev.timescalecreator.org
Cookie: loginSession=123
{
  "token": "123",
  "email": "oldemail@gmail.com"
}
```

#### Success Response

On success, the user's session is invalidated in the database, the user is assigned a random password, and they are sent an email with a link to change their password with a randomly generated token (expiring in 1 hour).

---

### Session Check

- **Endpoint:** `/auth/session-check`
- **Method:** `POST`
- **Description:** Used to check the status of ther user's session.
- **Requires Valid Session:** Yes

#### Request Body

Empty

#### Example Request

```http
POST /auth/session-check
Host: dev.timescalecreator.org
Cookie: loginSession=123
```

#### Responses

If the user is not logged in, the user does not exist in the database, or their session is invalid in the database the route responds with
```json
{
  "authenticated": "false"
}
```
otherwise,
```json
{
  "authenticated": true,
  "user": {
    "email": "email@gmail.com",
    "username": "username",
    "pictureUrl": "https://link.com",
    "isGoogleUser": true,
    "isAdmin": false,
    "workshopIds": [4],
    "accountType": "default",
    "uuid": "a29d589e-62c8-4c2b-997b-4156311d9cbc",
    "historyEntries": []
  }
}
```

---

### Upload Profile Picture

- **Endpoint:** `/upload-profile-picture`
- **Method:** `POST`
- **Description:** Upload a profile picture for the user that is stored on the server
- **Requires Valid Session:** Yes

#### Request Body

Empty

#### Example Request

```http
POST /upload-profile-picture
Host: dev.timescalecreator.org
Cookie: loginSession=123
```

#### Success Responses
Sends back a URL to access the uploaded picture
```json
{
  "pictureUrl": "https://dev.timescalecreator.org/profile-images/uuid/profile/profile-uuid.png"
}
```

---

### Change Username

- **Endpoint:** `/auth/change-username`
- **Method:** `POST`
- **Description:** Change a user's username
- **Requires Valid Session:** Yes

#### Request Body

| Name           | Type   | Description                                     | Required |
| -------------- | ------ | ----------------------------------------------- | -------- |
| newUsername    | string | The new username for the user                   | Yes      |
| recaptchaToken | string | The recaptcha token to verify the user is real  | Yes      |

#### Example Request

```http
POST /auth/change-username
Host: dev.timescalecreator.org
Cookie: loginSession=123
{
  "newUsername": "newUsername",
  "recaptchaToken": "123"
}
```

#### Success Responses
On success, the user will have their username updated and their previous session deleted.

---

### Change Password

- **Endpoint:** `/auth/change-password`
- **Method:** `POST`
- **Description:** Change a user's password. Different from forgot password as that has to go through an email since the user is not logged in
- **Requires Valid Session:** Yes

#### Request Body

| Name            | Type   | Description                                     | Required |
| --------------- | ------ | ----------------------------------------------- | -------- |
| currentPassword | string | The new password for the user                   | Yes      |
| newPassword     | string | The new password for the user                   | Yes      |
| recaptchaToken  | string | The recaptcha token to verify the user is real  | Yes      |

#### Example Request

```http
POST /auth/change-password
Host: dev.timescalecreator.org
Cookie: loginSession=123
{
  "currentPassword": "currentPassword",
  "newPassword": "newPassword",
  "recaptchaToken": "123"
}
```

#### Success Responses
On success, the user will have their password updated and their previous session deleted.

---

### Delete Profile

- **Endpoint:** `/auth/delete-profile`
- **Method:** `POST`
- **Description:** Delete a user's profile
- **Requires Valid Session:** Yes

#### Request Body

Empty

#### Example Request

```http
POST /auth/delete-profile
Host: dev.timescalecreator.org
Cookie: loginSession=123
```

#### Success Responses
On success, the user will have their profile deleted from the database, their folder deleted from the upload directory, metadata updated, and session deleted.

---

### Logout

- **Endpoint:** `/auth/logout`
- **Method:** `POST`
- **Description:** Logs out a user
- **Requires Valid Session:** Yes

#### Request Body

Empty

#### Example Request

```http
POST /auth/logout
Host: dev.timescalecreator.org
Cookie: loginSession=123
```

#### Success Responses
On success, the user's session will be deleted

---

This flowchart shows all the current flows for the login routes:

![flowchart](assets/Login-Flows.drawio.svg)

## Database Structure:

![database](assets/Database-Structure.drawio.svg)

## Translations

TSC online can change between different languages (currently English and Chinese). Each language has a translation file that the application pulls from.

### File Structure

Each language has a `CSV` file and a `JSON` file, where the CSV is the master and the JSON is the slave. The JSON file is overwritten by the translations in the CSV file everytime the developer runs `yarn dev`. The CSV files are positioned as the master because they are the files that the translators will be working on.

### Modifying Translations

The `yarn modify-translations` script creates a copy of the `en.json` translation file, which is named `dev-translation-en.json`. The developer can modify this file, and any changes made will be reflected in the relevent files. For example, changing a translation in `dev-translation-en.json` will change the corresponding translation in `en.csv`. Any removal of a key in the `dev-translation-en.json` file will remove the corresponding key in other languages if it exists. For example, if the key `login` exists in `zh.json` as well, then removing it in `dev.json` will remove it in `zh.json`.

### Verifying Translations

There are two checks run on github-actions that verifies translations. First is checking that the CSV files and JSON files have equivalent translations. This is because the CSV files are the files used by external translators, and we have to be sure that they match what shows up on the website. Second is checking that the translations that exist in other languages are a subset of the translations that exist in english. This is because we've decided that the english translation is the basis of our website.