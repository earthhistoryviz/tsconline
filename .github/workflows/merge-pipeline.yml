name: Merge Pipeline

on:
  pull_request:
    types: [opened, synchronize, reopened] # Runs on opening a pr, pushing to a pr, and reopening a pr
    branches:
      - main

jobs:
  check-files:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check for disallowed files and directories
        run: |
          declare -a disallowed_files=(".dpk" ".mdpk" ".txt" ".map" ".java" ".jar" ".DS_Store" "node_modules")
          disallowed_files_list=""
          for pattern in "${disallowed_files[@]}"; do
            files_found=$(find . -type f -name "*$pattern*" -not -path "./.git/*" -not -path "./node_modules/*")
            if [ ! -z "$files_found" ]; then
              disallowed_files_list+="$files_found\n"
            fi
          done
          if [ ! -z "$disallowed_files_list" ]; then
            echo -e "$disallowed_files_list" > disallowed_files_list.txt
            echo "disallowed_files_present=true" >> $GITHUB_ENV
          fi

      - name: Comment PR on disallowed files Failure
        if: env.disallowed_files_present == 'true'
        uses: actions/github-script@v5
        with:
          script: |
            const fs = require('fs');
            const disallowed_files_output = fs.readFileSync('disallowed_files_list.txt', 'utf8');
            const message = `ðŸš¨ There are files in your PR you need to remove:\n\n\`\`\`\n${disallowed_files_output}\n\`\`\`\n`;
            const prNumber = context.payload.pull_request.number;
            github.rest.issues.createComment({
              ...context.repo,
              issue_number: prNumber,
              body: message,
            });
          github-token: ${{ secrets.GITHUB_TOKEN }}

  code-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Dependencies
        run: yarn install

      - name: Run ESLint
        run: yarn lint-check > eslint-output.txt || echo "eslint_failed=true" >> $GITHUB_ENV
        continue-on-error: true

      - name: Comment PR on ESLint check failure
        if: env.eslint_failed == 'true'
        uses: actions/github-script@v5
        with:
          script: |
            const fs = require('fs');
            const eslintOutput = fs.readFileSync('eslint-output.txt', 'utf8');
            const message = `ðŸš¨ The ESLint check has failed. Please address the following issues:\n\n\`\`\`\n${eslintOutput}\n\`\`\`\nRun 'yarn lint-format' locally to fix some of these issues automatically.`;
            const prNumber = context.payload.pull_request.number;
            github.rest.issues.createComment({
              ...context.repo,
              issue_number: prNumber,
              body: message,
            });
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Prettify code
        run: |
          if ! yarn prettier-check; then
            echo "prettify_failed=true" >> $GITHUB_ENV
          fi
        continue-on-error: true

      - name: Comment PR on Prettier check failure
        if: env.prettify_failed == 'true'
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ðŸš¨ The Prettier check has failed. Please run 'yarn prettier-format' locally and commit the changes.

      - name: Check for any failures
        if: env.eslint_failed == 'true' || env.prettify_failed == 'true'
        run: exit 1

  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Dependencies
        run: yarn install

      - name: Build with Vite
        run: |
          set -o pipefail
          if ! yarn build 2>&1 | tee build.log; then
            echo "build_failed=true" >> $GITHUB_ENV
          fi
        continue-on-error: true

      - name: Report Build Errors
        if: env.build_failed == 'true'
        uses: actions/github-script@v5
        with:
          script: |
            const fs = require('fs');
            const buildLog = fs.readFileSync('build.log', 'utf8');
            const prNumber = context.payload.pull_request?.number;
            if (prNumber) {
              const message = `ðŸš¨ The build has failed. Please check the build logs for more information.\n\n\`\`\`\n${buildLog}\n\`\`\``;
              github.rest.issues.createComment({
                ...context.repo,
                issue_number: prNumber,
                body: message,
              });
            }
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Tests
        run: echo Testing # Test command would go here

      - name: Check for any failures
        if: env.build_failed == 'true'
        run: exit 1