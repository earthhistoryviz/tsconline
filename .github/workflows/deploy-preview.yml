name: Deploy PR previews

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
  # workflow_run:
  #   workflows: ["Merge Pipeline"]
  #   types:
  #     - completed

concurrency: preview-${{ github.ref }}

jobs:
  deploy-preview:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Add known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H dev.geolex.org >> ~/.ssh/known_hosts

      - name: Transfer files
        run: |
          rsync -avz --exclude '.git' ./ deployuser@dev.geolex.org:/home/aaron/tsconline/pr-preview-${{ github.event.number }}/
      
      - name: Create deployment preview
        run: |
          ssh deployuser@dev.geolex.org << 'EOF'
          cd /home/aaron/tsconline
          mkdir -p pr-preview-${{ github.event.number }}
          cd pr-preview-${{ github.event.number }}
          echo "PR_ID=${{ github.event.number }}" > .env
          cp ../server/assets/jars/* ./server/assets/jars/
          mkdir -p ./server/assets/datapacks
          cp ../server/assets/datapacks/* ./server/assets/datapacks/
          docker-compose -f docker-compose-preview.yml up -d pr-preview
          while ! docker-compose -f docker-compose-preview.yml logs | grep -q "Server listening on  { address: '0.0.0.0', family: 'IPv4', port: 3000 }"; do
            echo "Waiting for server to start..."
            sleep 5
          done
          echo "Server is up"
          EOF

      - name: Comment on PR
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ðŸš€ Deployed preview to https://pr-${{ github.event.number }}.geolex.org
